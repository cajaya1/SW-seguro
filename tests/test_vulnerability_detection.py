"""
Test script to demonstrate detailed vulnerability detection
"""

from vulnerability_detector import detect_vulnerabilities, format_vulnerability_report, get_vulnerability_summary
import joblib
import pandas as pd

# Test with vulnerable.py
print("=" * 80)
print("TESTING VULNERABLE FILE: vulnerable.py")
print("=" * 80)

with open('vulnerable.py', 'r', encoding='utf-8') as f:
    code_vulnerable = f.read()

vulnerabilities = detect_vulnerabilities(code_vulnerable, 'vulnerable.py')
print(format_vulnerability_report(vulnerabilities, 'vulnerable.py'))

# Test with seguro.py
print("\n" + "=" * 80)
print("TESTING SECURE FILE: seguro.py")
print("=" * 80)

with open('seguro.py', 'r', encoding='utf-8') as f:
    code_secure = f.read()

vulnerabilities_secure = detect_vulnerabilities(code_secure, 'seguro.py')
print(format_vulnerability_report(vulnerabilities_secure, 'seguro.py'))

# Load ML model and test prediction
print("\n" + "=" * 80)
print("ML MODEL PREDICTION TEST")
print("=" * 80)

model = joblib.load('modelo_seguridad_final.pkl')

# Test vulnerable.py with model
print("\nFile: vulnerable.py")
df_test = pd.DataFrame([{
    'nloc': len(code_vulnerable.split('\n')),
    'avg_complexity': 5,
    'max_complexity': 10,
    'risk_keywords': 5,
    'sanitization_count': 0,
    'risk_density': 0.5,
    'comment_ratio': 0.1,
    'code': code_vulnerable,
    'filename': 'vulnerable.py'
}])

prob = model.predict_proba(df_test)[0][1]
status = "VULNERABLE" if prob > 0.40 else "SECURE"
print(f"ML Model Status: {status}")
print(f"Risk Probability: {prob:.1%}")

# Test seguro.py with model
print("\nFile: seguro.py")
df_test_secure = pd.DataFrame([{
    'nloc': len(code_secure.split('\n')),
    'avg_complexity': 5,
    'max_complexity': 10,
    'risk_keywords': 0,
    'sanitization_count': 5,
    'risk_density': 0.0,
    'comment_ratio': 0.2,
    'code': code_secure,
    'filename': 'seguro.py'
}])

prob_secure = model.predict_proba(df_test_secure)[0][1]
status_secure = "VULNERABLE" if prob_secure > 0.40 else "SECURE"
print(f"ML Model Status: {status_secure}")
print(f"Risk Probability: {prob_secure:.1%}")
