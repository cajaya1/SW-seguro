# Sistema de Detecci√≥n de Vulnerabilidades - Gu√≠a de Uso

## Descripci√≥n

Este sistema ahora incluye **detecci√≥n detallada de vulnerabilidades** que no solo identifica si un archivo es vulnerable, sino que tambi√©n:

1. **Identifica el tipo espec√≠fico de vulnerabilidad**
2. **Indica la l√≠nea exacta** donde se encuentra
3. **Muestra el c√≥digo vulnerable**
4. **Proporciona la severidad** (CRITICAL, HIGH, MEDIUM, LOW)
5. **Ofrece recomendaciones** de soluci√≥n

## Tipos de Vulnerabilidades Detectadas

### 1. SQL Injection (HIGH)
- Concatenaci√≥n de strings en queries SQL
- Uso de f-strings, % formatting, o + en consultas
- Ejemplo detectado: `cursor.execute("SELECT * FROM users WHERE id = '" + user_id + "'")`

### 2. Cross-Site Scripting - XSS (HIGH)
- Renderizado de input del usuario sin sanitizaci√≥n
- innerHTML, document.write, render_template_string
- Ejemplo detectado: `return f"<h1>Welcome {username}</h1>"`

### 3. Command Injection (CRITICAL)
- Ejecuci√≥n de comandos del sistema con input del usuario
- os.system(), subprocess con shell=True, os.popen()
- Ejemplo detectado: `os.system(f"ping {user_input}")`

### 4. Code Injection (CRITICAL)
- Ejecuci√≥n din√°mica de c√≥digo
- eval(), exec(), compile()
- Ejemplo detectado: `eval(user_input)`

### 5. Path Traversal (HIGH)
- Control de rutas de archivo por el usuario
- open(), os.path.join() sin validaci√≥n
- Ejemplo detectado: `open(request.args.get('file'))`

### 6. Deserialization (CRITICAL)
- Deserializaci√≥n de datos no confiables
- pickle.loads(), yaml.load()
- Ejemplo detectado: `pickle.loads(untrusted_data)`

### 7. Weak Cryptography (MEDIUM)
- Uso de algoritmos d√©biles
- MD5, SHA1, random.random()
- Ejemplo detectado: `hashlib.md5(password)`

### 8. Hardcoded Secrets (HIGH)
- Credenciales en el c√≥digo
- Passwords, API keys, tokens
- Ejemplo detectado: `API_KEY = "sk-1234567890"`

### 9. Unsafe File Operations (MEDIUM)
- Operaciones de archivo peligrosas
- os.remove(), chmod 777
- Ejemplo detectado: `os.remove(user_filename)`

## Uso del Sistema

### 1. Demo Interactivo (demo_scanner.py)

```bash
python demo_scanner.py
```

Ingresa la ruta del archivo a analizar:
```
Enter file path to analyze: vulnerable.py
```

**Salida:**
```
Analysis results for: vulnerable.py
================================================================================
Status: HIGH RISK
Risk probability: 85.3%
Complexity metrics: NLOC=45, Avg Complexity=3.50
Risk indicators: 5 patterns detected

[!] DETAILED VULNERABILITY ANALYSIS:
   Total vulnerabilities found: 3
   By severity: {'CRITICAL': 2, 'HIGH': 1}
   By type: {'CODE_INJECTION': 1, 'SQL_INJECTION': 2}

[!] VULNERABILITIES FOUND IN: vulnerable.py
================================================================================

[CRITICAL] CRITICAL SEVERITY (1 found)
--------------------------------------------------------------------------------

Type: CODE_INJECTION
Line: 40
Code: res = eval(calculo)
Issue: Code Injection vulnerability. Dynamic code execution with untrusted input.
Fix: Never use eval() or exec() with user input. Use safe alternatives.

...
```

### 2. Escaneo para CI/CD (scan_security.py)

```bash
# Escanear un archivo
python scan_security.py vulnerable.py

# Escanear un directorio
python scan_security.py src/
```

**Salida JSON (`security_scan_results.json`):**
```json
{
  "total": 5,
  "secure": 2,
  "vulnerable": 3,
  "errors": 0,
  "vulnerable_files": [
    {
      "status": "VULNERABLE",
      "probability": 0.85,
      "file": "auth.py",
      "vulnerabilities": [
        {
          "type": "SQL_INJECTION",
          "line": 23,
          "code": "cursor.execute(query)",
          "severity": "HIGH",
          "description": "SQL Injection vulnerability detected...",
          "recommendation": "Use parameterized queries..."
        }
      ],
      "vulnerability_summary": {
        "total": 3,
        "by_severity": {"HIGH": 2, "MEDIUM": 1},
        "by_type": {"SQL_INJECTION": 2, "WEAK_CRYPTO": 1}
      }
    }
  ],
  "passed": false
}
```

### 3. Demostraci√≥n Completa (demo_comprehensive_scan.py)

```bash
python demo_comprehensive_scan.py
```

Analiza m√∫ltiples archivos de prueba y genera un informe completo:

```
================================================================================
FINAL SUMMARY
================================================================================

Total files analyzed: 5
Total vulnerabilities found: 15

Detailed breakdown:
  vulnerable.py: [!] 1 issues
    Severity: {'CRITICAL': 1}
  secure.py: [+] SECURE
  test_sql_injection.py: [!] 4 issues
    Severity: {'HIGH': 4}
  test_xss_path.py: [!] 2 issues
    Severity: {'HIGH': 2}
  test_command_crypto.py: [!] 8 issues
    Severity: {'CRITICAL': 2, 'MEDIUM': 2, 'HIGH': 4}
```

## Integraci√≥n con CI/CD

El archivo `.github/workflows/ci-cd-pipeline.yml` ya est√° configurado para usar el detector detallado:

```yaml
- name: Run AI Security Scan
  run: |
    python scan_security.py .
    
- name: Parse Scan Results
  if: always()
  run: |
    if [ -f security_scan_results.json ]; then
      python -c "
import json
with open('security_scan_results.json') as f:
    results = json.load(f)
    for file in results.get('vulnerable_files', []):
        print(f\"\\n‚ö†Ô∏è {file['file']}:\")
        for vuln in file.get('vulnerabilities', []):
            print(f\"  - Line {vuln['line']}: {vuln['type']} ({vuln['severity']})\")
            print(f\"    Code: {vuln['code']}\")
            print(f\"    Fix: {vuln['recommendation']}\")
      "
    fi
```

Esto generar√° comentarios en el Pull Request con:
- Archivos vulnerables detectados
- L√≠nea exacta del problema
- Tipo de vulnerabilidad
- Severidad
- Recomendaci√≥n de soluci√≥n

## M√≥dulo de Detecci√≥n (vulnerability_detector.py)

Puedes importar el m√≥dulo en tus propios scripts:

```python
from vulnerability_detector import (
    detect_vulnerabilities,
    get_vulnerability_summary,
    format_vulnerability_report
)

# Leer c√≥digo
with open('app.py', 'r') as f:
    code = f.read()

# Detectar vulnerabilidades
vulnerabilities = detect_vulnerabilities(code, 'app.py')

# Obtener resumen
summary = get_vulnerability_summary(vulnerabilities)
print(f"Found {summary['total']} vulnerabilities")
print(f"By severity: {summary['by_severity']}")
print(f"By type: {summary['by_type']}")

# Generar reporte
report = format_vulnerability_report(vulnerabilities, 'app.py')
print(report)
```

## Archivos de Prueba

El repositorio incluye archivos de prueba para demostrar la detecci√≥n:

- `vulnerable.py` - Ejemplo con eval() (Code Injection)
- `secure.py` - C√≥digo seguro sin vulnerabilidades
- `test_sql_injection.py` - SQL Injection ejemplos
- `test_xss_path.py` - XSS y Path Traversal
- `test_command_crypto.py` - Command Injection y Weak Crypto

## Precisi√≥n del Detector

El detector usa:

1. **Machine Learning**: Modelo Random Forest para clasificaci√≥n inicial (VULNERABLE/SECURE)
2. **An√°lisis Basado en Reglas**: Regex patterns espec√≠ficos para identificar tipos y l√≠neas exactas
3. **Balance de Detecci√≥n**: Minimiza falsos positivos (ej. `re.compile()` no se detecta como Code Injection)

## Ejemplo de Salida Completa

```
[!] VULNERABILITIES FOUND IN: auth.py
================================================================================

[CRITICAL] CRITICAL SEVERITY (2 found)
--------------------------------------------------------------------------------

Type: SQL_INJECTION
Line: 145
Code: cursor.execute(f"SELECT * FROM users WHERE id = {user_id}")
Issue: SQL Injection vulnerability detected. User input is directly concatenated into SQL queries.
Fix: Use parameterized queries or prepared statements.

Type: CODE_INJECTION
Line: 289
Code: result = eval(calculation)
Issue: Code Injection vulnerability. Dynamic code execution with untrusted input.
Fix: Never use eval() or exec() with user input. Use safe alternatives.

[HIGH] HIGH SEVERITY (1 found)
--------------------------------------------------------------------------------

Type: HARDCODED_SECRETS
Line: 12
Code: API_KEY = "sk-prod-1234567890"
Issue: Hardcoded credentials or secrets found in code.
Fix: Store secrets in environment variables or secure vaults. Never commit credentials to version control.

================================================================================
SUMMARY: 3 total vulnerabilities found
Severity breakdown: {'CRITICAL': 2, 'HIGH': 1}
================================================================================
```

## Ventajas del Sistema Mejorado

‚úÖ **Detecci√≥n precisa de tipo** - No solo dice "vulnerable", sino QU√â tipo de vulnerabilidad  
‚úÖ **Localizaci√≥n exacta** - N√∫mero de l√≠nea espec√≠fico para correcci√≥n inmediata  
‚úÖ **C√≥digo vulnerable mostrado** - Contexto completo de la l√≠nea problem√°tica  
‚úÖ **Severidad clasificada** - Priorizaci√≥n de correcciones (CRITICAL primero)  
‚úÖ **Recomendaciones actionables** - Gu√≠a espec√≠fica de c√≥mo corregir  
‚úÖ **Resumen estad√≠stico** - Overview r√°pido de issues por tipo y severidad  
‚úÖ **Integraci√≥n CI/CD** - Comentarios autom√°ticos en Pull Requests  
‚úÖ **Salida estructurada** - JSON para procesamiento automatizado  

## Pr√≥ximos Pasos

Una vez que el modelo ML est√© optimizado (82%+ accuracy), el sistema completo estar√° listo para:

1. Configurar ramas (dev, test, main)
2. Activar GitHub Actions workflow
3. Configurar bot de Telegram
4. Desplegar a producci√≥n

El sistema de detecci√≥n detallada ya est√° completamente funcional y listo para usar. üöÄ
